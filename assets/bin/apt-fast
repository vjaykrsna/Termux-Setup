#!/data/data/com.termux/files/usr/bin/bash
# Minimal apt-fast wrapper for Termux
DOWNLOADER="aria2c"
OPTIONS="-s8 -x8 -k1M"

# metadata ops, just pass to apt-get
if [[ "$1" == "update" || "$1" == "upgrade" ]]; then
    exec apt-get "$@"
fi

# install/download with aria2
if [[ "$1" == "install" || "$1" == "download" ]]; then
    shift
    for pkg in "$@"; do
        if [[ "$pkg" == -* ]]; then
            ARGS+=("$pkg")
        else
            PKGS+=("$pkg")
        fi
    done

    # prefetch package URLs
    for pkg in "${PKGS[@]}"; do
        URLS=$(apt-get --print-uris install -y "${pkg}" | cut -d"'" -f2 | grep -E '^http')
        if [[ -n "$URLS" ]]; then
            $DOWNLOADER $OPTIONS -d $PREFIX/var/cache/apt/archives $URLS
        fi
    done

    # then install from local cache
    exec apt-get install -y "${PKGS[@]}"
else
    exec apt-get "$@"
fi
